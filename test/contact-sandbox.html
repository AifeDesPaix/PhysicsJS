<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            html, body { height: 100%; }
            body {
                background-color: #ffffff;
                margin: 0;
                overflow: hidden;
            }

            canvas {
                position: absolute;

            }

            .pjs-meta {
                position: absolute;
                top: 1em;
                right: 1em;
                font-size: 16px;
                font-family: monospace;
            }

            .debug-el {
                position: absolute;
                bottom: 0;
                right: 0;
                background: white;
                font: monospace;
            }
        </style>
    </head>
    <body>
        <script src="../lib/pixi.js"></script>
        <script src="../lib/dat.gui.js"></script>
        <script src="../_working/physicsjs/physicsjs-full.js"></script>
        <script>

            var viewWidth = parent.innerWidth
                ,viewHeight = parent.innerHeight;

            var bodyStyles = { strokeStyle: '#888', fillStyle: 'transparent', lineWidth: 2, angleIndicator: 'rgba(200, 200, 100, 1)' };

            function setup(world) {

                var renderer = Physics.renderer('debug', {
                        el: 'viewport',
                        width: viewWidth,
                        height: viewHeight,
                        meta: true,
                        styles: {
                            'circle': bodyStyles
                            ,'rectangle': bodyStyles
                            ,'convex-polygon': bodyStyles
                        }
                    })
                    ,edgeBounce
                    // bounds of the window
                    ,viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight)
                    ;

                // add the renderer
                world.add(renderer);
                // render on each step
                world.on('step', function () {
                    world.render();
                });

                world.add( Physics.integrator('velocity-verlet') );

                // resize events
                window.addEventListener('resize', function () {

                    viewWidth = parent.innerWidth;
                    viewHeight = parent.innerHeight;

                    viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight);
                    // edgeBounce.setAABB(viewportBounds);

                }, true);

                world.add([

                    Physics.behavior('sweep-prune')
                    ,Physics.behavior('body-collision-detection', {
                        checkAll: false
                    })

                    // ,Physics.behavior('body-impulse-response')
                    // add gravity
                    // ,Physics.behavior('constant-acceleration')
                ]);

                // Physics.util.ticker.on(function (time, dt) {
                //
                //     world.step(time);
                // });

                setInterval(function(){
                    world.step();
                }, 500);
            }

            function initEvents( world ){

                var grab = false
                    ,start
                    ,mouseStart
                    ;

                document.addEventListener('mousedown', function( e ){
                    var pos = Physics.vector({ x: e.pageX, y: e.pageY })
                        ,body
                        ;

                    body = world.findOne({ $at: pos });

                    if ( body ){
                        grab = body;
                        start = body.state.pos.clone();
                        mouseStart = pos;
                    }
                });

                document.addEventListener('mousemove', Physics.util.throttle(function( e ){
                    var pos;

                    if ( grab ){
                        pos = Physics.vector({ x: e.pageX, y: e.pageY });
                        pos.vsub( mouseStart );

                        grab.state.pos.clone( start ).vadd( pos );

                        world.step();
                    }
                }, 1000/60));

                document.addEventListener('mouseup', function(){

                    grab = false;
                    world.step();
                });

            }

            function makeThing(x, y){
                return Physics.body('compound', {
                    x: x
                    ,y: y
                    // ,offset: Physics.vector( -60, 0 )
                    ,children: [
                        Physics.body('circle', {
                            x: 50
                            ,y: 0
                            ,radius: 30
                            ,mass: 1
                            ,offset: Physics.vector( 0, 10 )
                        })
                        ,Physics.body('rectangle', {
                            x: -30
                            ,y: 0
                            ,width: 60
                            ,height: 60
                            ,angle: Math.PI/4
                            ,mass: 1
                            // ,offset: Physics.vector( -60, 0 )
                        })
                    ]
                });
            }

            function addBodies( world, P ){

                // world.add( Physics.body('circle', {
                //     x: viewWidth/2,
                //     y: viewHeight - 20,//+100,
                //     radius: 20,
                //     width: 40,
                //     height: 40,
                //     mass: 1.4,
                //     offset: Physics.vector(10, 2),
                //     angle: Math.PI/2,
                //     //cof: 0,
                //     //vy: -0.2,
                //     // vx: 0.1,
                //     restitution: 1
                // }));
                //
                // world.add( Physics.body('circle', {
                //     x: viewWidth/2,
                //     y: viewHeight - 100,//+100,
                //     radius: 20,
                //     width: 40,
                //     height: 40,
                //     mass: 1.4,
                //     offset: Physics.vector(-10, 2),
                //     // angle: Math.PI/2,
                //     //cof: 0,
                //     //vy: -0.2,
                //     // vx: 0.1,
                //     restitution: 0.9
                // }));
                //
                // var polygons = [
                //     {x:410, y:220, v:[{x: 0, y: 80}, {x: 80, y: 0}, {x: 0, y: -80},{x: -30, y: -30}, {x: -30, y: 30}] },
                //     {x:290, y:320, v:[{x: 0, y: 80}, {x: 80, y: 0}, {x: 0, y: -80},{x: -30, y: -30}, {x: -30, y: 30}], angle: Math.PI  }
                // ];
                //
                // for(var i = 0;i < polygons.length;i++){
                //     world.add(
                //         Physics.body('convex-polygon', {
                //           x: polygons[i].x,
                //           y: polygons[i].y,
                //           vertices: polygons[i].v,
                //           angle: polygons[i].angle,
                //
                //           restitution: 0.5,
                //           cof: 1
                //         })
                //     );
                // }


                // world.add( makeThing(400, 600) );
                // world.add( makeThing(400, 500) );
                //
                var rectangles = [
                    { x: 500, y: 60, w: 50, h: 20, mass: 1 }
                    ,{ x: 300, y: 60, w: 100, h: 80, mass: 2 }
                    // ,{ x: 500, y: 100, w: 150, h: 300, mass: 3 }
                ];

                for(var i = 0;i < rectangles.length;i++){
                    world.add(
                        Physics.body('rectangle', {
                          x: rectangles[i].x,
                          y: rectangles[i].y,
                          width: rectangles[i].w,
                          height: rectangles[i].h,
                          angle: rectangles[i].angle,
                          mass: rectangles[i].mass,

                          restitution: 0.6,
                          cof: 1
                        })
                    );
                }


            }

            function initGJKTools( world, Physics ){

                var minkowskiStyles = {
                    strokeStyle: 'rgba(0, 0, 200, 0.5)'
                    ,fillStyle: 'rgba(0, 0, 200, 0.1)'
                    ,lineWidth: 1
                };

                function drawMinkowski(renderer, ctx, support){
                    var dir = Physics.vector(1, 0)
                        ,point = Physics.vector()
                        ,dtheta = 0.1
                        ,verts = []
                        ;

                    for ( var i = 0, l = 2; i < l; i += dtheta ){

                        dir.rotate( dtheta*Math.PI );
                        point.clone( support( dir ).pt );
                        verts.push( point.values() );
                    }

                    var x = ctx.canvas.width/2
                        ,y = ctx.canvas.height/2
                        ;
                    ctx.translate(x, y);
                    renderer.drawCircle( 0, 0, 1, 'red', ctx );
                    renderer.drawPolygon( verts, minkowskiStyles, ctx );
                    ctx.translate(-x, -y);
                }

                var dirStyles = { lineWidth: 1, strokeStyle: '#000' };
                var currentSimplex = 0;
                function drawSimplex( renderer, ctx, simplexes ) {
                    var idx = currentSimplex % simplexes.length;
                    var simplex = simplexes[ idx ];
                    if (!simplex || !simplex.length) return;

                    var x = ctx.canvas.width/2
                        ,y = ctx.canvas.height/2
                        ;

                    ctx.strokeText('simplexes: '+simplexes.length, 0, 12);
                    ctx.strokeText('idx: '+idx, 0, 22);
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.beginPath();
                    ctx.moveTo(simplex[0].pt.x, simplex[0].pt.y);

                    for ( var i = 1; i < simplex.length; i++ ) {
                        ctx.lineTo(simplex[i].pt.x, simplex[i].pt.y);
                    }

                    ctx.lineWidth = 1;
                    ctx.strokeStyle = simplex.details.noOverlap ? 'rgba(0, 100, 100, 0.8)' : 'rgba(0, 200, 0, 0.8)';
                    ctx.stroke();
                    renderer.drawLine( Physics.vector.zero, simplex.dir.mult(20), dirStyles, ctx );
                    var last = simplex[ simplex.length - 1 ].pt;
                    renderer.drawCircle(last.x, last.y, 2, 'gold', ctx);
                    ctx.restore();
                }

                var renderer = world.renderer();
                var layer = renderer.addLayer('gjk', null, { autoResize: false, width: 600, height: 600, zIndex: 10 });
                layer.el.style.right = '0';
                layer.el.style.left = '';

                var bodyA = world.getBodies()[0];
                var bodyB = world.getBodies()[1];
                var support = Physics.gjk.getSupportFn(bodyA, bodyB);

                layer.render = function(){

                    layer.el.width = layer.el.width;

                    var simplexes = [];
                    function pushSimplex( s, dir, details ){
                        var sx = s.map(function(s){
                            return Physics.util.extend({}, s);
                        });
                        sx.details = details;
                        sx.dir = dir.clone().normalize();
                        simplexes.push( sx );
                    }
                    support.update();
                    support.useCore = false;
                    support.marginA = 0;
                    support.marginB = 0;
                    var result = Physics.gjk( support, Physics.vector.axis[0], false, pushSimplex );
                    var simplex = result.simplex;
                    var distance = result.distance;
                    var closest = result.closest;
                    var overlap = result.overlap;

                    if ( !bodyA.realView ){
                        bodyA.realView = bodyA.view;
                    }
                    if ( !bodyB.realView ){
                        bodyB.realView = bodyB.view;
                    }

                    if ( overlap ){

                        bodyA.view = bodyA._overlapView || (bodyA._overlapView = renderer.createView( bodyA.geometry, 'rgba(200, 0, 0, 0.4)' ));
                        bodyB.view = bodyB._overlapView || (bodyB._overlapView = renderer.createView( bodyB.geometry, 'rgba(200, 0, 0, 0.4)' ));

                    } else {

                        bodyA.view = bodyA.realView;
                        bodyB.view = bodyB.realView;

                        if ( closest ){
                            layer.ctx.save();
                            // layer.ctx.translate( layer.el.width/2, layer.el.height/2 );
                            renderer.drawLine(result.closest.a, result.closest.b, 'tomato', layer.ctx);
                            renderer.drawCircle(result.closest.a.x, result.closest.a.y, 2, 'steelblue', layer.ctx);
                            renderer.drawCircle(result.closest.b.x, result.closest.b.y, 2, 'steelblue', layer.ctx);
                            layer.ctx.restore();
                        }
                    }

                    drawMinkowski( renderer, layer.ctx, support );
                    drawSimplex( renderer, layer.ctx, simplexes );
                };

                window.addEventListener('keydown', function( e ){
                    if ( e.keyCode === 39 ){
                        currentSimplex++;
                    } else if ( e.keyCode === 37 ){
                        currentSimplex--;
                    }
                });

            }

            Physics({ timestep: 2, maxIPF: 24 }, [
                setup
                ,addBodies
                // ,zeroPointSeven
                ,initEvents
                ,initGJKTools
            ]);

        </script>
    </body>
</html>
