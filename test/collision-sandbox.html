<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <style>
            body {
                background-color: #ffffff;
                margin: 0;
                overflow: hidden;
            }

            canvas {
                position: absolute;

            }

            .pjs-meta {
                position: absolute;
                bottom: 0;
                right: 0;
                font-size: 20px;
                font-family: monospace;
            }

            #debug {
                position: absolute;
                top: 2em;
                left: 2em;
                background: rgba( 255, 255, 255, 0.4 );
                color: #333;

                font-size: 14px;
                line-height: 1.3;
                font-family: monospace;
            }
        </style>
    </head>
    <body>
        <div id="debug"></div>
        <script src="../lib/pixi.js"></script>
        <script src="../_working/physicsjs/physicsjs-full.js"></script>
        <script>

            var viewWidth = parent.innerWidth
                ,viewHeight = parent.innerHeight;

            var debugEl = document.getElementById('debug');
            var doDebug = false;
            var sp;

            function debug(){
                var lines = Array.prototype.join.call(arguments, '<br/>');
                debugEl.innerHTML = lines;
            }

            function setup(world) {

                var renderer = Physics.renderer('canvas', {
                        el: 'viewport',
                        width: viewWidth,
                        height: viewHeight,
                        meta: true,
                        // debug:true,
                        styles: {
                            'circle': {
                                strokeStyle: 'grey',
                                lineWidth: 1,
                                fillStyle: 'black',
                                angleIndicator: 'white'
                            },
                            'convex-polygon': {
                                strokeStyle: 'grey',
                                lineWidth: 1,
                                fillStyle: 'black',
                                angleIndicator: 'none'
                            }
                        }
                    })
                    ,edgeBounce
                    // bounds of the window
                    ,viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight)
                    ;

                // add the renderer
                world.add(renderer);
                // render on each step
                world.on('step', function () {
                    world.render();
                });

                edgeBounce = Physics.behavior('edge-collision-detection', {
                    aabb: viewportBounds,
                    restitution: 0.5,
                    cof: 1
                });

                world.add( Physics.integrator('velocity-verlet') );

                // resize events
                window.addEventListener('resize', function () {

                    viewWidth = parent.innerWidth;
                    viewHeight = parent.innerHeight;

                    renderer.el.width = viewWidth;
                    renderer.el.height = viewHeight;

                    viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight);
                    edgeBounce.setAABB(viewportBounds);

                }, true);

                world.add([
                    edgeBounce
                    ,sp = Physics.behavior('sweep-prune')
                    ,Physics.behavior('body-collision-detection', {
                        checkAll: false
                    })

                    ,Physics.behavior('body-impulse-response')
                    // add gravity
                    ,Physics.behavior('constant-acceleration')
                    // ,Physics.behavior('newtonian')
                    ,Physics.behavior('interactive', {el: renderer.el.parentNode})
                ]);

                Physics.util.ticker.on(function (time, dt) {

                    world.step(time);
                });
            }

            function initEvents( world ){

                var grab = false
                    ,start
                    ,mouseStart
                    ;

                document.addEventListener('mousedown', function( e ){
                    var pos = Physics.vector({ x: e.pageX, y: e.pageY })
                        ,body
                        ;

                    body = world.findOne({ $at: pos });

                    if ( body ){
                        grab = body;
                        start = body.state.pos.clone();
                        mouseStart = pos;
                    }
                });

                document.addEventListener('mousemove', Physics.util.throttle(function( e ){
                    var pos;

                    if ( grab ){
                        pos = Physics.vector({ x: e.pageX, y: e.pageY });
                        pos.vsub( mouseStart );

                        grab.state.pos.clone( start ).vadd( pos );

                        world.step();
                    }
                }, 1000/60));

                document.addEventListener('mouseup', function(){

                    grab = false;
                    world.step();
                });

                document.addEventListener('keydown', function( e ){
                    if ( e.keyCode === 13 ){
                        doDebug = true;
                        world.step();
                        doDebug = false;
                    }
                });
            }

            function addBodies( world ){

                var bodyStyles = { strokeStyle: '#888', fillStyle: 'transparent', lineWidth: 2, angleIndicator: 'rgba(200, 200, 100, 1)' };

                world.add( Physics.body('circle', {
                    x: viewWidth/2,
                    y: viewHeight - 20,//+100,
                    radius: 20,
                    width: 40,
                    height: 40,
                    mass: 1.4,
                    //cof: 0,
                    //vy: -0.2,
                    // vx: 0.1,
                    restitution: 1,
                    styles: bodyStyles
                }));

                world.add( Physics.body('circle', {
                	x: viewWidth/2,
                	y: viewHeight - 100,//+100,
                	radius: 20,
                	width: 40,
                	height: 40,
                	mass: 1.4,
                	//cof: 0,
                	//vy: -0.2,
                	// vx: 0.1,
                	restitution: 0.9,
                	styles: bodyStyles
                }));

                var polygons = [
                    {x:410, y:220, v:[{x: 0, y: 80}, {x: 80, y: 0}, {x: 0, y: -80},{x: -30, y: -30}, {x: -30, y: 30}] },
                    {x:290, y:320, v:[{x: 0, y: 80}, {x: 80, y: 0}, {x: 0, y: -80},{x: -30, y: -30}, {x: -30, y: 30}], angle: Math.PI  }
                ];

                for(var i = 0;i < polygons.length;i++){
                    world.add(
                        Physics.body('convex-polygon', {
                          x: polygons[i].x,
                          y: polygons[i].y,
                          vertices: polygons[i].v,
                          angle: polygons[i].angle,

                          styles: bodyStyles,
                          restitution: 0.5,
                          cof: 1
                        })
                    );
                }

                var rectangles = [
                    { x: 100, y: 60, w: 50, h: 20, mass: 1 }
                    ,{ x: 300, y: 60, w: 100, h: 80, mass: 2 }
                    ,{ x: 500, y: 100, w: 150, h: 300, mass: 3 }
                ];

                for(var i = 0;i < rectangles.length;i++){
                    world.add(
                        Physics.body('rectangle', {
                          x: rectangles[i].x,
                          y: rectangles[i].y,
                          width: rectangles[i].w,
                          height: rectangles[i].h,
                          angle: rectangles[i].angle,
                          mass: rectangles[i].mass,

                          styles: bodyStyles,
                          restitution: 0.6,
                          cof: 1
                        })
                    );
                }
            }


            function setupRenderer( world ){

                var renderer = world.renderer();
                var styles = {
                    lineWidth: 2
                    ,strokeStyle: 'red'
                };

                var firstPoint = {
                    fillStyle: 'green'
                };
                var secondPoint = {
                    fillStyle: 'blue'
                };

                var layer = renderer.addLayer('contacts', null, {
                    zIndex: 2
                });

                layer.render = function(){};

                function drawContact( c ){
                    var ctx = layer.ctx;
                    var from = Physics.vector( c.pos ).vadd( c.bodyA.state.pos );
                    var to = Physics.vector( from ).vsub( Physics.vector(c.mtv) )

                    renderer.drawLine( from, to, styles, ctx );
                    renderer.drawCircle( from.x, from.y, 2, firstPoint, ctx );
                    renderer.drawCircle( to.x, to.y, 2, secondPoint, ctx );

                    if ( doDebug ){
                        var pad = 100;
                        ctx.fillStyle = '#333';
                        ctx.strokeWidth = 1;
                        ctx.font = '14px monospace';
                        ctx.fillText('pos: (' + c.pos.x.toFixed(0) + ', ' + c.pos.y.toFixed(0) + ')', from.x + pad, from.y );
                        ctx.fillText('mtv: (' + c.mtv.x.toFixed(0) + ', ' + c.mtv.y.toFixed(0) + ')', from.x + pad, from.y + 16 );
                    }
                }

                var intervalStyles = {
                    min: { strokeStyle: 'rgba( 0, 0, 200, 0.1 )', lineWidth: 2, fillStyle: 'transparent' }
                    ,max: { strokeStyle: 'rgba( 200, 0, 0, 0.1 )', lineWidth: 2, fillStyle: 'transparent' }
                };

                function drawInterval( intr ){
                    var ctx = layer.ctx;
                    var scratch = Physics.scratchpad();
                    var from = scratch.vector().set( intr.val.x, 0 );
                    var to = scratch.vector().set( intr.val.x, intr.tracker.body.state.pos.y );

                    renderer.drawLine( from, to, intervalStyles[ intr.type ? 'max' : 'min' ], ctx );
                    renderer.drawCircle( from.x, from.y, 4, intervalStyles[ intr.type ? 'max' : 'min' ], ctx );

                    from.set( 0, intr.val.y );
                    to.set( intr.tracker.body.state.pos.x, intr.val.y );

                    renderer.drawLine( from, to, intervalStyles[ intr.type ? 'max' : 'min' ], ctx );
                    renderer.drawCircle( from.x, from.y, 4, intervalStyles[ intr.type ? 'max' : 'min' ], ctx );

                    scratch.done();
                }

                var colsDetected, candidatesDetected;

                world.on('beforeStep', function(){
                    // clear
                    layer.el.width = layer.el.width;

                    candidatesDetected = false;
                    colsDetected = false;
                });

                world.on('collisions:candidates', function( data ){

                    candidatesDetected = data.candidates;

                }, this, 100);


                world.on('collisions:detected', function( data ){
                    var cols = data.collisions;

                    colsDetected = cols;

                    for ( var i = 0, l = cols.length; i < l; i++ ){
                        drawContact( cols[i] );
                    }
                });

                world.on('step', function(){

                    var intr;
                    for ( var xy = 0; xy < 2; xy++ ){
                        intr = sp.intervalLists[ xy ];
                        for ( var i = 0, l = intr.length; i < l; i++ ){

                            drawInterval( intr[ i ] );
                        }
                    }

                    debug(
                        'candidates: ' + ((candidatesDetected && candidatesDetected.length)|0),
                        'collisions: ' + ((colsDetected && colsDetected.length)|0)
                    );
                });

                world.step();
            }


            Physics({ timestep: 6, maxIPF: 24 }, [
                setup
                ,addBodies
                //,initEvents
                ,setupRenderer
            ]);

        </script>
    </body>
</html>
